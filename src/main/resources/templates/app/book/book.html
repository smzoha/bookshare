<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{base}"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${book.title}"></title>
</head>
<body>
<div layout:fragment="pageContent">
    <div class="container mt-5">
        <!--/*@thymesVar id="book" type="com.zedapps.bookshare.entity.book.Book"*/-->
        <div class="row g-4">
            <div class="col-md-4 text-center">
                <div class="d-flex justify-content-center">
                    <img th:src="@{/image/{id}(id=${book.image.id})}" th:alt="${book.title}"
                         class="book-display-cover mb-3"
                         th:if="${book.image ne null}"/>

                    <img th:src="@{/img/book-placeholder.png}" th:alt="${book.title}" class="book-display-cover mb-3"
                         th:if="${book.image eq null}"/>
                </div>
                <div class="d-flex justify-content-center gap-2" sec:authorize="isAuthenticated()">
                    <div class="btn-group">
                        <button class="btn default-shelf" th:data-shelf-id="${defaultShelf.id}"
                                th:classappend="${defaultShelf.containsBook(book) ? 'remove-from-shelf btn-success'
                                        : 'add-to-shelf btn-bookshare'}">

                            <i class="fa-regular fa-bookmark me-1"></i> <span th:text="${defaultShelf.name}"></span>
                            <span class="fa fa-check-circle" th:if="${defaultShelf.containsBook(book)}"></span>
                        </button>

                        <button type="button" class="btn dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false"
                                th:classappend="${defaultShelf.containsBook(book) ? 'btn-success' : 'btn-bookshare'}">
                            <span class="visually-hidden">Toggle Default Shelf Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li th:each="shelf : ${defaultShelves}">
                                <a href="#" class="dropdown-item" th:data-shelf-id="${shelf.id}"
                                   th:classappend="${shelf.containsBook(book) ? 'remove-from-shelf' : 'add-to-shelf'}">
                                    <span th:text="${shelf.name}"/>&nbsp;
                                    <span class="fa fa-check-circle" th:if="${shelf.containsBook(book)}"></span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-bookshare dropdown-toggle" type="button" id="shelfDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false" th:text="#{label.add.shelf}">
                        </button>

                        <ul class="dropdown-menu" aria-labelledby="shelfDropdown">
                            <li th:each="shelf : ${shelves}">
                                <a href="#" class="dropdown-item" th:data-shelf-id="${shelf.id}"
                                   th:classappend="${shelf.containsBook(book) ? 'remove-from-shelf' : 'add-to-shelf'}">
                                    <span th:text="${shelf.name}"/>&nbsp;
                                    <span class="fa fa-check-circle" th:if="${shelf.containsBook(book)}"></span>
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider" th:if="${shelvesTruncated}">
                            </li>
                            <li th:if="${shelvesTruncated}">
                                <a href="#" class="dropdown-item" th:text="#{label.show.more}" data-bs-toggle="modal" data-bs-target="#shelfModal"/>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" th:text="#{label.create.new.shelf}"
                                   data-bs-toggle="modal" data-bs-target="#addShelfModal"/></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-8 text-bookshare">
                <h2 class="fw-bold" th:text="${book.title}"></h2>
                <p class="text-muted mb-1"><strong th:text="${book.authorNames}"></strong></p>
                <p class="mb-2"><i class="fa-solid fa-tag me-1"></i>&nbsp;<span th:text="${book.genresNames}"></span></p>

                <div class="mt-1 mb-1 rating">
                    <ul class="list-inline">
                        <th:block th:each="i : ${#numbers.sequence(1, T(java.lang.Math).floor(book.averageRating))}" th:if="${book.averageRating >= 1}">
                            <li class="fa-solid fa-star"></li>
                        </th:block>

                        <li class="fa-solid fa-star-half-stroke"
                            th:if="${(book.averageRating % 1) >= 0.25 and (book.averageRating % 1) < 0.75}">
                        </li>

                        <th:block th:each="i : ${#numbers.sequence(1, (5 - T(java.lang.Math).ceil(book.averageRating)))}"
                                th:if="${(5 - T(java.lang.Math).ceil(book.averageRating))} > 0">
                            <li class="fa-regular fa-star"></li>
                        </th:block>
                    </ul>

                    <small class="text-muted">
                        <span th:text="|#{label.average.ratings}: ${#numbers.formatDecimal(book.averageRating, 1, 2)}|"></span>
                        <i class="fa-solid fa-diamond text-bookshare"></i>
                        <span th:text="|${book.reviews.size()} #{label.reviews}|"></span>
                    </small>
                </div>

                <div class="book-description collapsed">
                    <p th:utext="${book.description}"></p>
                </div>

                <button id="toggleDescription" class="btn btn-link text-bookshare mt-2" th:text="#{label.show.more}"></button>
            </div>
        </div>

        <div class="row mt-5" sec:authorize="isAuthenticated()">
            <div class="col-12">
                <h4 class="text-bookshare mb-3">
                    <span class="fa fa-glasses"></span>
                    <span th:text="#{label.reading.progress}"></span>
                </h4>

                <div class="mb-4 p-3 block-section rounded shadow-sm">
                    <div class="list-group overflow-auto" style="max-height: 30vh;">
                        <th:block th:each="progress, status : ${readingProgresses}">
                            <div class="list-group-item reading-progress-item d-flex flex-column flex-md-row align-items-md-center gap-2 small">
                                <span th:text="${status.index + 1}"></span>

                                <span>
                                    <i class="fa fa-clock me-1"></i>
                                    <span class="text-muted" th:text="${#temporals.format(progress.startDate, 'dd-MM-yyyy')}"></span>
                                    â€“
                                    <span class="text-muted" th:text="${#temporals.format(progress.endDate, 'dd-MM-yyyy')}"></span>
                                </span>

                                <span>
                                    <i class="fa fa-book-open me-1 text-bookshare"></i>
                                    <span class="text-muted" th:text="|${progress.pagesRead}/${book.pages}|"></span>
                                    <span class="text-muted" th:text="|(${progress.percentile}%)|"></span>
                                </span>

                                <div class="flex-grow-1 mx-2 min-w-0">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar"
                                             th:style="|width: ${(progress.pagesRead * 100) / book.pages}%|"
                                             th:classappend="${progress.completed} ? ' bg-success' : 'bg-warning'">
                                        </div>
                                    </div>
                                </div>

                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary ms-md-auto align-self-start align-self-md-center progress-edit"
                                        th:data-progress-id="${progress.id}"
                                        th:data-pages-read="${progress.pagesRead}"
                                        th:data-start-date="${#temporals.format(progress.startDate, 'yyyy-MM-dd')}"
                                        th:data-end-date="${#temporals.format(progress.endDate, 'yyyy-MM-dd')}"
                                        th:data-completed="${progress.completed}">
                                    <i class="fa fa-angle-double-right"></i>
                                </button>
                            </div>
                        </th:block>
                    </div>

                    <div class="col-12 text-end mt-3">
                        <button class="btn btn-bookshare" th:text="#{label.add.new}" data-bs-toggle="modal" data-bs-target="#readingModal"></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <h4 class="text-bookshare mb-3">
                    <span class="fa fa-pencil"></span>
                    <span th:text="#{label.reviews}"></span>
                </h4>

                <div class="mb-4 p-3 block-section rounded shadow-sm">
                    <th:block sec:authorize="isAuthenticated()">
                        <form th:action="@{/book/addReview}" th:method="post" th:object="${reviewDto}">
                            <h6 th:text="#{label.add.review}"/>
                            <input type="hidden" name="bookId" th:value="${book.id}"/>

                            <div class="mb-2 rating">
                                <i class="fa-regular fa-star me-1" id="rating-input-1" data-rating="1"></i>
                                <i class="fa-regular fa-star me-1" id="rating-input-2" data-rating="2"></i>
                                <i class="fa-regular fa-star me-1" id="rating-input-3" data-rating="3"></i>
                                <i class="fa-regular fa-star me-1" id="rating-input-4" data-rating="4"></i>
                                <i class="fa-regular fa-star me-1" id="rating-input-5" data-rating="5"></i>
                                <input type="hidden" id="ratingValue" th:field="*{rating}"/>

                                <div th:if="${#fields.hasErrors('rating')}" class="text-danger">
                                    <span th:errors="*{rating}"></span>
                                </div>
                            </div>

                            <label for="content" class="visually-hidden" th:text="#{label.reviews}"/>
                            <textarea id="content" th:field="*{content}" class="form-control mb-2" rows="3"
                                      th:placeholder="#{label.review.placeholder}"></textarea>

                            <div th:if="${#fields.hasErrors('content')}" class="text-danger">
                                <span th:errors="*{content}"></span>
                            </div>

                            <button class="btn btn-bookshare"
                                    th:classappend="${#fields.hasAnyErrors()} ? 'mt-2' : ''"
                                    th:text="#{label.post.review}"/>
                        </form>
                    </th:block>
                    <th:block sec:authorize="!isAuthenticated()">
                        <div class="alert alert-warning">
                            <span th:text="#{warning.review.log.in}"></span>
                        </div>
                    </th:block>
                </div>

                <div id="reviewSection" th:insert="~{app/book/reviewList :: reviewList}"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h4 class="text-bookshare mb-3" th:text="#{label.related.books}"/>
                <div class="gap-3 recent-books-slider">
                    <div class="d-flex flex-column align-items-center book-box" th:each="book : ${relatedBooks}">
                        <a th:href="@{/book/{id}(id=${book.id})}">
                            <img th:src="@{/image/{id}(id=${book.image.id})}" th:alt="${book.title}"
                                 class="book-cover mb-3"
                                 th:if="${book.image ne null}"/>

                            <img th:src="@{/img/book-placeholder.png}" th:alt="${book.title}" class="book-cover mb-3"
                                 th:if="${book.image eq null}"/>
                        </a>

                        <p class="mb-0 mt-1 text-bookshare text-center" th:text="${book.title}"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addShelfFragment" th:insert="~{app/book/shelfAddFragment :: shelfAddModal}"></div>
    <div id="allShelfFragment" th:if="${shelvesTruncated}" th:insert="~{app/book/shelfModalFragment :: shelfModal}"></div>
    <div id="readingProgressFragment" th:insert="~{app/book/readingProgressFragment :: readingProgressModal}"></div>

    <script type="application/javascript" th:inline="javascript">
        const showMoreText = /*[[#{label.show.more}]]*/ '';
        const showLessText = /*[[#{label.show.less}]]*/ '';
        const bookId = /*[[${book.id}]]*/ 0;

        const showReadingProgressModal = /*[[${showReadingProgressModal}]]*/ false;

        const toggleDescriptionButton = $('#toggleDescription');
        const descriptionPanel = $('.book-description');

        const ratingValueInputSelector = $('#ratingValue');

        const readingModal = $('#readingModal');
        const readingModalObject = new bootstrap.Modal(readingModal);

        $(function () {
            toggleDescriptionButton.on('click', function () {
                descriptionPanel.toggleClass('collapsed');
                toggleDescriptionButton.text(descriptionPanel.hasClass('collapsed') ? showMoreText : showLessText);
            });

            $('[id^="rating-input"]').on('click', function (e) {
                let rating = $(e.target).data('rating'), currentRating = parseInt(ratingValueInputSelector.val() || 0);

                if (rating === currentRating) {
                    for (let i = 1; i <= 5; i++) {
                        $('#rating-input-' + i).removeClass('fa-solid').addClass('fa-regular');
                    }

                    ratingValueInputSelector.val('');

                } else {
                    ratingValueInputSelector.val(rating);

                    for (let i = 1; i <= rating; i++) {
                        $('#rating-input-' + i).removeClass('fa-regular').addClass('fa-solid');
                    }

                    for (let i = rating + 1; i <= 5; i++) {
                        $('#rating-input-' + i).removeClass('fa-solid').addClass('fa-regular');
                    }
                }
            });

            $(document).on('click', '.page-btn', function (e) {
                e.preventDefault();
                let page = $(this).data('page');

                $.ajax({
                    url: `reviews/${bookId}?page=${page}`,
                    type: 'GET',
                    beforeSend: () => showLoader(),
                    success: function (fragment) {
                        $('#reviewSection').html(fragment);
                    },
                    error: () => console.error('Unable to retrieve reviews!'),
                    complete: () => removeLoader()
                })
            });

            $(document).on('click', '.progress-edit', function (e) {
                e.preventDefault();
                let progressEditButton = $(e.currentTarget);

                readingModal.find('[name="id"]').val(progressEditButton.data('progress-id'))
                readingModal.find('[name="pagesRead"]').val(progressEditButton.data('pages-read'));
                readingModal.find('[name="startDate"]').val(progressEditButton.data('start-date'));
                readingModal.find('[name="endDate"]').val(progressEditButton.data('end-date'));
                readingModal.find('[name="completed"]').prop('checked', progressEditButton.data('completed'));

                readingModalObject.show();
            });

            readingModal.on('hidden.bs.modal', function () {
                const $form = $(this).find('form');

                $form[0].reset();
                $form.find('input[name="id"]').val('');

                $form.removeClass('was-validated');
            });

            if (showReadingProgressModal) {
                readingModalObject.show();
            }

            $('.add-to-shelf, .remove-from-shelf').on('click', function (e) {
                let shelfOption = $(e.currentTarget);
                let shelfId = shelfOption.data('shelfId');
                let add = shelfOption.hasClass('add-to-shelf');

                $.ajax({
                    url: add ? 'addShelf' : 'removeShelf',
                    type: 'POST',
                    data: {
                        'bookId': bookId,
                        'shelfId': shelfId
                    },
                    beforeSend: () => showLoader(),
                    success: function () {
                        window.location.href = `/book/${bookId}`;
                    },
                    error: () => console.error('Unable to add/remove book to shelf!'),
                    complete: () => removeLoader()
                })
            });
        });
    </script>
</div>
</body>
</html>